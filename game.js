!function(){function e(e){return L.getElementById(e)}function n(e){return L.createElement(e)}function t(e){var n,t,i;for(var r in e)n=e[r],t=n.id,isMonster="monster"===n.type,i=isMonster?en[t]:X[t],i&&O&&t!==O.id&&(i.x=n.x,i.y=n.y),isMonster?en[t]=n:i&&(i.facing=n.facing)}function i(){if(!z){var e=X[O.id];e.isDead=0,E.emit("userRespawn",{id:O.id}),rn=0,z=10,Q.style.display="none",H.className=""}}function r(){G=setInterval(function(){un=!0},W)}function a(){if(!rn){rn=1,z=10;var n=e("timer");n.innerHTML=z;var t=setInterval(function(){n.innerHTML=--z,0===z&&(n.innerHTML="Respawn",clearTimeout(t))},1e3)}}function o(){if(sn&&!O.isInvincible){sn=!1;var e=w(O);e&&(O.health-=e.damage,O.health<=0&&(O.isDead=1)&&(H.className="d",Q.style.display="block"),E.emit("hitUser",{id:O.id,damage:e.damage,fromMonster:1}));var n=g(O);n&&E.emit("userPickup",{id:O.id,powerUp:n})}}function l(e,n,t){return e.y=e.y+Math.sin(hn*n)*t,e.x=e.x+Math.cos(hn*n)*t,e}function c(){if(O.isDead)return!z&&32 in nn&&i(),void 0;var e={id:O.id},n=!1;if(s()){var t=0!==Object.keys(nn).length&&O.speed*J;65 in nn?n=83 in nn?135:87 in nn?225:180:68 in nn?n=83 in nn?45:87 in nn?315:0:87 in nn?n=270:83 in nn&&(n=90),n!==!1&&(pn.x=O.x,pn.y=O.y,pn=l(pn,n,t),O.x=pn.x,O.y=pn.y,e.x=O.x,e.y=O.y)}var r;38 in nn?r=37 in nn?"up-left":39 in nn?"up-right":"up":40 in nn?r=37 in nn?"down-left":39 in nn?"down-right":"down":37 in nn?r="left":39 in nn&&(r="right"),r&&(O.facing=r,e.facing=r),(n||r)&&E.emit("updateMovement",e),n=0;var a=0,o=0;32 in nn&&(un&&("up"===O.facing?(n=270,a=-10,o=-30):"up-left"===O.facing?(n=225,a=-25,o=-15):"up-right"===O.facing?(n=315,a=10,o=-20):"down"===O.facing?(n=90,a=-10,o=0):"down-left"===O.facing?(n=135,a=-15,o=5):"down-right"===O.facing?(n=45,a=5,o=5):"left"===O.facing?(n=180,a=-25):"right"===O.facing&&(n=0),O.powerup&&"shotgun"===O.powerup.type&&(d(a,o,n-15),d(a,o,n+15)),d(a,o,n)),un=!1)}function d(e,n,t){var i=new f(O.x+O.height/2+e,O.y+O.width/2+n,O.facing,t,O.id);$[i.id]=i,E.emit("newBullet",i),R(i.x)}function u(){for(var e=U();_[e];)e=U();return _[e]=1,e}function s(){return O.x<=0||O.y<=0?(O.x=O.x+1,O.y=O.y+1,!1):O.x>=760?(O.x=O.x-5,!1):O.y>=550?(O.y=O.y-5,!1):!0}function f(e,n,t,i,r){var a=this;a.owner=r,a.id=r+u(),a.x=e,a.y=n,a.width=5,a.height=5,a.direction=t,a.angle=i,a.speed=500}function h(){var e;for(var n in $)e=$[n],e.owner===O.id&&delete $[n]}function p(e){e.direction;var n=e.speed*J;if(yn.x=e.x,yn.y=e.y,yn=l(yn,e.angle,n),e.x=yn.x,e.y=yn.y,e.owner===Y){var t=e.owner,i=m(e);if(!i)return delete $[e.id],E.emit("killBullet",e.id),void 0;var r=v(e);!r||r.isInvincible||r.isDead||(r.health-=1,r.health<=0&&delete X[r.id],E.emit("hitUser",{id:r.id,damage:1,shooter:t}));var a=w(e);a&&(a.health-=1,a.health<=0&&delete en[a.id],E.emit("hitMonster",{id:a.id,damage:1,shooter:t})),(r||a)&&(delete $[e.id],E.emit("killBullet",e.id))}}function y(e,n){var t=e.width+e.x,i=n.width+n.x;if(n.x>t||e.x>i)return!1;var r=e.height+e.y,a=n.height+n.y;return n.y>r||e.y>a?!1:!0}function v(e){var n,t;for(var i in X)if(n=X[i],n.id!==Y&&(t=y(e,n)))return n;return!1}function w(e){var n,t;for(var i in en)if(n=en[i],t=y(e,n))return n;return!1}function g(e){var n,t;for(var i in Z)if(n=Z[i],t=y(e,n))return n;return!1}function m(e){return e.x>800||e.y>600||e.x<0||e.y<0?!1:!0}function x(e){var n=new vn;n.src="images/shotgun.png",F.drawImage(n,e.x,e.y,70,25)}function k(e){var n=new vn;n.src="images/hp.png",F.drawImage(n,e.x,e.y,45,45)}function b(e){var n=[];for(var t in X)n.push(X[t]);for(var i in en)n.push(en[i]);if(on||ln)for(var r in Z)n.push(Z[r]);n.sort(function(e,n){return e.x===n.x&&e.y===n.y&&e.type!==n.type?"monster"===e.type?1:-1:e.y===n.y?e.x>n.x?1:e.x<n.x?-1:0:e.y>n.y?1:-1});for(var a,o=0,l=n.length;l>o;o++)a=n[o],"player"===a.type&&!a.isDead&&a.isConnected?D(e,a):"monster"===a.type?I(e,a):"shotgun"===a.type?x(a):"health"===a.type&&k(a)}function D(e,n){var t;if(n.hitCountdown&&1===n.hitCountdown%10&&(n.show=!n.show),n.hitCountdown--,n.hitCountdown||(n.show=1),n.show){C(e,n),e.beginPath(),e.fillStyle="white",t=mn;var i=O.id===n.id?"You":n.name;e.fillText(i,n.x+12,n.y+65);var r=0;switch(n.facing){case"up":break;case"up-left":r=52;break;case"down":r=358;break;case"down-left":r=307;break;case"left":r=205;break;case"right":r=154;break;case"up-right":r=102;break;case"down-right":r=256}e.drawImage(t,0,r,49,49,n.x,n.y,40,45),e.fill(),e.stroke(),e.closePath()}}function I(e,n){e.drawImage(gn,n.x,n.y,n.width,n.height)}function M(){fn&&(F.rect(0,0,H.width,H.height),F.fillStyle=fn,F.fill()),F.fillRect(0,0,H.width,H.height),b(F);var e,n;for(var t in $)e=$[t],n=e&&X[e.owner],e&&n&&!n.isDead&&(p(e),e&&(F.fillStyle="#d62822"),e&&F.fillRect(e.x,e.y,3,3),e&&(F.fillStyle="#f2b830"),e&&F.fillRect(e.x+4,e.y,3,3));var i=O.health;F.fillStyle="rgba(255, 0, 0, 0.5)";var r=(H.width-10)/10,a=r*i;F.fillRect(5,5,a,15)}function C(e,n){var t="left"===n.facing||"down-left"===n.facing||"up-left"===n.facing?15:"down"===n.facing||"up"===n.facing?10.5:5;e.fillStyle=n.color,e.fillRect(n.x+t,n.y+25,20,10),e.fillStyle=n.eyeColor,e.fillRect(n.x+t+3,n.y+10,14,10),e.fillStyle=n.pantsColor,e.fillRect(n.x-1+t+2,n.y+35,17,7)}function S(){var e,t,i,r=L.createDocumentFragment();tn.sort(function(e,n){return e.score>n.score?-1:e.score<n.score?1:0});for(var a in tn)i=tn[a],e=n("tr"),e.style.outline="thin solid "+i.color,t=n("td"),t.innerText=i.name,e.appendChild(t),t=n("td"),t.innerText=i.score,e.appendChild(t),r.appendChild(e);j.innerHTML="",j.appendChild(r)}function T(){J=(Date.now()-an)/1e3,o(),c(),M(),an=Date.now(),window.requestAnimationFrame(T)}function P(){for(var e=2*xn.sampleRate,n=xn.createBuffer(1,e,xn.sampleRate),t=n.getChannelData(0),i=0;e>i;i++)t[i]=2*U()-1;return n}function R(e){var n=xn.createBufferSource(),t=xn.createPanner();B(e,t),n.connect(t),bn.frequency.value=900+q(201*U())-100,t.connect(bn),n.buffer=kn,n.loop=!0,n.loopStart=U()*(kn.duration/2),n.start(0),n.stop(xn.currentTime+.04)}function B(e,n){H.width;var t,i=q(H.width/2),r=22;e===i?t=0:i>e?t=(i-e)/i*-r:e>i&&(t=(e-i)/i*r);var a=t,o=a+90;o>90&&(o=180-o);var l=Math.sin(a*(Math.PI/180)),c=Math.sin(o*(Math.PI/180));n.setPosition(l,0,c)}var E=io.connect("http://shootah.nodejitsu.com:80"),L=document,N=Math,U=N.random,q=N.floor,H=e("canvas"),j=e("st"),F=H.getContext("2d");H.width=800,H.height=600;var J,A,O,Y,z,G,K,Q=e("r"),V=e("m"),W=150,X={},Z={},$={},_={},en={},nn={},tn={},rn=0,an=Date.now(),on=0,ln=0;try{var cn=window.localStorage.getItem("user");O=cn?JSON.parse(cn):{},O.isDead=0,O.health=10,O.name?E.emit("userJoined",O):(H.style.display="none",e("c").style.display="block",e("submit").addEventListener("click",function(){var n=L.getElementsByTagName("input")[0].value;n&&(O.name=n,H.style.display="block",e("c").style.display="none",E.emit("userJoined",O))}))}catch(dn){throw new Error(dn)}E.on("join",function(e){A=E.socket.sessionid,e.socketId===A&&(console.log(e),window.localStorage.setItem("user",JSON.stringify(e)),O=e,Y=e.id,window.requestAnimationFrame(T)),X[e.id]=e}),E.on("move",function(e){if(e.id!==O.id)if(e.id){var n={};n[e.id]=e,t(n)}else t(e)}),E.on("newBullet",function(e){$[e.id]||e.owner===O.id||($[e.id]=e,R(e.x))}),E.on("killBullet",function(e){$[e]&&delete $[e]}),E.on("killedMonster",function(e){en[e]&&delete en[e]}),E.on("userDamaged",function(e){var n=X[e.id];n&&(n.health=e.health,n.hitCountdown=100)}),E.on("shotgunPowerUpDrop",function(e){Z[e.id]=e,on=1}),E.on("healthPowerUpDrop",function(e){Z[e.id]=e,ln=1}),E.on("userDeath",function(e,n){var t=X[e];t&&(t.isDead=1,e===Y&&(V.innerHTML=n,a(),h()))}),E.on("userNotInvincible",function(e){var n=X[e];n&&(n.isInvincible=0)}),E.on("userPickup",function(e,n){delete Z[n.id];var t=X[e],i=1e4;on=0,ln=0,W="shotgun"===O.powerup.type?200:150,clearInterval(G),r(),t.powerup&&"shotgun"===t.powerup.type&&clearTimeout(K),t.id===O.id&&(O.powerup=n,"health"===n.type&&(t.health=10,O.health=10),K=setTimeout(function(){O.powerup="",E.emit("powerUpEnd",{id:t.id}),W="shotgun"===O.powerup.type?500:150,clearInterval(G),r(),i-=1e3},i))}),E.on("updateScore",function(e){tn=e,S()}),window.addEventListener("keydown",function(e){O.name&&!O.isDead&&e.preventDefault(),nn[e.keyCode]=!0}),window.addEventListener("keyup",function(e){O.name&&!O.isDead&&e.preventDefault(),delete nn[e.keyCode]}),Q.addEventListener("click",i);var un=!0;r();var sn=!0;setInterval(function(){sn=!0},500);var fn,hn=Math.PI/180,pn={x:0,y:0},yn={x:0,y:0},vn=Image,wn=new vn;wn.onload=function(){fn=F.createPattern(wn,"repeat")},wn.src="images/grass3.jpg";var gn=new vn;gn.src="images/monster-right.png";var mn=new vn;mn.src="images/character-sprite-reg.png";var xn=new webkitAudioContext,kn=P(),bn=xn.createBiquadFilter();bn.type=0,bn.frequency.value=900,bn.connect(xn.destination)}();