!function(){function e(e){return H.getElementById(e)}function n(e){return H.createElement(e)}function t(e){var n,t,i;for(var r in e)n=e[r],t=n.id,isMonster="monster"===n.type,i=isMonster?un[t]:rn[t],i&&Q&&t!==Q.id&&(i.x=n.x,i.y=n.y),isMonster?un[t]=n:i&&(i.facing=n.facing)}function i(){if(!Z){var e=rn[Q.id];e.health=10,e.isDead=0,G.emit("userRespawn",{id:Q.id}),dn=0,Z=10,en.style.display="none",V.className=""}}function r(){$&&clearInterval($),$=setInterval(function(){wn=1},tn)}function o(){if(!dn){dn=1,Z=10;var n=e("timer");n.innerHTML=Z;var t=setInterval(function(){n.innerHTML=--Z,0===Z&&(n.innerHTML="Respawn",clearTimeout(t))},1e3)}}function a(){if(gn&&!Q.isInvincible){gn=!1;var e=g(Q);e&&(Q.health-=e.damage,Q.health<=0&&(V.className="d",en.style.display="block"),G.emit("hitUser",{id:Q.id,damage:e.damage,fromMonster:1}));var n=m(Q);n&&G.emit("userPickup",{id:Q.id,powerUp:n})}}function c(e,n,t){return e.y=e.y+Math.sin(xn*n)*t,e.x=e.x+Math.cos(xn*n)*t,e}function u(){if(Q.isDead)return!Z&&32 in ln&&i(),void 0;var e={id:Q.id},n=!1;if(f()){var t=0!==Object.keys(ln).length&&Q.speed*z;65 in ln?n=83 in ln?135:87 in ln?225:180:68 in ln?n=83 in ln?45:87 in ln?315:0:87 in ln?n=270:83 in ln&&(n=90),n!==!1&&(kn.x=Q.x,kn.y=Q.y,kn=c(kn,n,t),Q.x=kn.x,Q.y=kn.y,e.x=Q.x,e.y=Q.y)}var r;38 in ln?r=37 in ln?"up-left":39 in ln?"up-right":"up":40 in ln?r=37 in ln?"down-left":39 in ln?"down-right":"down":37 in ln?r="left":39 in ln&&(r="right"),r&&(Q.facing=r,e.facing=r),(n||r)&&l(e),n=0;var o=0,a=0;32 in ln&&(wn&&("up"===Q.facing?(n=270,o=-10,a=-30):"up-left"===Q.facing?(n=225,o=-25,a=-15):"up-right"===Q.facing?(n=315,o=10,a=-20):"down"===Q.facing?(n=90,o=-10,a=0):"down-left"===Q.facing?(n=135,o=-15,a=5):"down-right"===Q.facing?(n=45,o=5,a=5):"left"===Q.facing?(n=180,o=-25):"right"===Q.facing&&(n=0),Q.powerup&&"shotgun"===Q.powerup.type&&(s(o,a,n-15),s(o,a,n+15)),s(o,a,n)),wn=!1)}function l(e){Cn&&(Cn=0,G.emit("updateMovement",e),setTimeout(function(){Cn=1},33))}function s(e,n,t){var i=new h(Q.x+Q.height/2+e,Q.y+Q.width/2+n,Q.facing,t,Q.id);an[i.id]=i,G.emit("newBullet",i),B(i.x)}function d(){for(var e=O();cn[e];)e=O();return cn[e]=1,e}function f(){return Q.x<=0||Q.y<=0?(Q.x=Q.x+1,Q.y=Q.y+1,!1):Q.x>=760?(Q.x=Q.x-5,!1):Q.y>=550?(Q.y=Q.y-5,!1):!0}function h(e,n,t,i,r){var o=this;o.owner=r,o.id=r+d(),o.x=e,o.y=n,o.width=5,o.height=5,o.direction=t,o.angle=i,o.speed=500}function p(){var e;for(var n in an)e=an[n],e.owner===Q.id&&delete an[n]}function y(e){e.direction;var n=e.speed*z;if(Dn.x=e.x,Dn.y=e.y,Dn=c(Dn,e.angle,n),e.x=Dn.x,e.y=Dn.y,e.owner===X){var t=e.owner,i=x(e);if(!i)return delete an[e.id],G.emit("killBullet",e.id),void 0;var r=w(e);!r||r.isInvincible||r.isDead||(r.health-=1,r.health<=0&&(rn[r.id].isDead=1),G.emit("hitUser",{id:r.id,damage:1,shooter:t}));var o=g(e);o&&(o.health-=1,o.health<=0&&delete un[o.id],G.emit("hitMonster",{id:o.id,damage:1,shooter:t})),(r||o)&&(delete an[e.id],G.emit("killBullet",e.id))}}function v(e,n){var t=e.width+e.x,i=n.width+n.x;if(n.x>t||e.x>i)return!1;var r=e.height+e.y,o=n.height+n.y;return n.y>r||e.y>o?!1:!0}function w(e){var n,t;for(var i in rn)if(n=rn[i],n.id!==X&&(t=v(e,n)))return n;return!1}function g(e){var n,t;for(var i in un)if(n=un[i],t=v(e,n))return n;return!1}function m(e){var n,t,i;for(var r in on)if(n=on[r],t=v(e,n),i="shotgun"===n.type?hn:pn,t&&i)return n;return!1}function x(e){return e.x>800||e.y>600||e.x<0||e.y<0?!1:!0}function k(e){var n=new bn;n.src="images/shotgun.png",Y.drawImage(n,e.x,e.y,70,25)}function C(e){var n=new bn;n.src="images/hp.png",Y.drawImage(n,e.x,e.y,45,45)}function D(e){var n=[];for(var t in rn)n.push(rn[t]);for(var i in un)n.push(un[i]);if(hn||pn)for(var r in on)n.push(on[r]);n.sort(function(e,n){return e.x===n.x&&e.y===n.y&&e.type!==n.type?"monster"===e.type?1:-1:e.y===n.y?e.x>n.x?1:e.x<n.x?-1:0:e.y>n.y?1:-1});for(var o,a=0,c=n.length;c>a;a++)o=n[a],"player"===o.type&&!o.isDead&&o.isConnected?b(e,o):"monster"===o.type?M(e,o):"shotgun"===o.type?k(o):"health"===o.type&&C(o)}function b(e,n){var t;if(n.hitCountdown&&1===n.hitCountdown%10&&(n.show=!n.show),n.hitCountdown--,n.hitCountdown||(n.show=1),n.show){T(e,n),e.beginPath(),e.fillStyle="white",t=Tn;var i=Q.id===n.id?"You":n.name;e.fillText(i,n.x+12,n.y+65);var r=0;switch(n.facing){case"up":break;case"up-left":r=52;break;case"down":r=358;break;case"down-left":r=307;break;case"left":r=205;break;case"right":r=154;break;case"up-right":r=102;break;case"down-right":r=256}e.drawImage(t,0,r,49,49,n.x,n.y,40,45),e.fill(),e.stroke(),e.closePath()}}function M(e,n){var t=n.speed*z,i=c(n,n.angle,t);n.x=i.x,n.y=i.y,e.drawImage(In,n.x,n.y,n.width,n.height)}function I(){mn&&(Y.rect(0,0,V.width,V.height),Y.fillStyle=mn,Y.fill()),Y.fillRect(0,0,V.width,V.height),D(Y);var e,n;for(var t in an)e=an[t],n=e&&rn[e.owner],e&&n&&!n.isDead&&(y(e),e&&(Y.fillStyle="#d62822"),e&&Y.fillRect(e.x,e.y,3,3),e&&(Y.fillStyle="#f2b830"),e&&Y.fillRect(e.x+4,e.y,3,3));var i=Q.health;Y.fillStyle="rgba(255, 0, 0, 0.5)";var r=(V.width-10)/10,o=r*i;Y.fillRect(5,5,o,15)}function T(e,n){var t="left"===n.facing||"down-left"===n.facing||"up-left"===n.facing?15:"down"===n.facing||"up"===n.facing?10.5:5;e.fillStyle=n.color,e.fillRect(n.x+t,n.y+25,20,10),e.fillStyle=n.eyeColor,e.fillRect(n.x+t+3,n.y+10,14,10),e.fillStyle=n.pantsColor,e.fillRect(n.x-1+t+2,n.y+35,17,7)}function S(){var e,t,i,r=H.createDocumentFragment();sn.sort(function(e,n){return e.score>n.score?-1:e.score<n.score?1:0});for(var o in sn)i=sn[o],e=n("tr"),e.style.outline="thin solid "+i.color,t=n("td"),t.innerText=i.name,e.appendChild(t),t=n("td"),t.innerText=i.score,e.appendChild(t),r.appendChild(e);W.innerHTML="",W.appendChild(r)}function P(){z=(Date.now()-fn)/1e3,a(),u(),I(),fn=Date.now(),window.requestAnimationFrame(P)}function R(){for(var e=2*Sn.sampleRate,n=Sn.createBuffer(1,e,Sn.sampleRate),t=n.getChannelData(0),i=0;e>i;i++)t[i]=2*O()-1;return n}function B(e){var n=Sn.createBufferSource(),t=Sn.createPanner();E(e,t),n.connect(t),Rn.frequency.value=900+j(201*O())-100,t.connect(Rn),n.buffer=Pn,n.loop=!0,n.loopStart=O()*(Pn.duration/2),n.start(0),n.stop(Sn.currentTime+.04)}function E(e,n){V.width;var t,i=j(V.width/2),r=22;e===i?t=0:i>e?t=(i-e)/i*-r:e>i&&(t=(e-i)/i*r);var o=t,a=o+90;a>90&&(a=180-a);var c=Math.sin(o*(Math.PI/180)),u=Math.sin(a*(Math.PI/180));n.setPosition(c,0,u)}function N(e){var n=e-49;return 440*Math.pow(2,n/12)}function L(){var e=60/Ln;Un+=.25*e,Bn++,32==Bn&&(Bn=0)}function q(e,n){var t,i;Jn.push({note:e,time:n});for(var r in En)i=En[r][e],void 0!==i&&(t=musicContext.createOscillator(),t.type=1,t.connect(musicGainNode),t.frequency.value=N(i),t.start(n),t.stop(n+Fn))}function A(){for(;Un<musicContext.currentTime+An;)q(Bn,Un),L();Gn=window.setTimeout(A,qn)}function U(){return Nn=!Nn,Nn?(Bn=0,Un=musicContext.currentTime,A(),"stop"):(window.clearTimeout(Gn),"play")}function F(){for(var e=Hn,n=musicContext.currentTime;Jn.length&&Jn[0].time<n;)e=Jn[0].note,Jn.splice(0,1);requestAnimationFrame(F)}var G=io.connect("http://localhost:8080"),H=document,J=Math,O=J.random,j=J.floor,V=e("canvas"),W=e("st"),Y=V.getContext("2d");V.width=800,V.height=600;var z,K,Q,X,Z,$,_,en=e("r"),nn=e("m"),tn=150,rn={},on={},an={},cn={},un={},ln={},sn={},dn=0,fn=Date.now(),hn=0,pn=0;try{var yn=window.localStorage.getItem("user");Q=yn?JSON.parse(yn):{},Q.isDead=0,Q.health=10,Q.name?G.emit("userJoined",Q):(V.style.display="none",e("c").style.display="block",e("submit").addEventListener("click",function(){var n=H.getElementsByTagName("input")[0].value;n&&(Q.name=n,V.style.display="block",e("c").style.display="none",G.emit("userJoined",Q))}))}catch(vn){throw new Error(vn)}G.on("join",function(e){K=G.socket.sessionid,e.socketId===K&&(console.log(e),window.localStorage.setItem("user",JSON.stringify(e)),Q=e,X=e.id,window.requestAnimationFrame(P)),rn[e.id]=e}),G.on("move",function(e){if(e.id!==Q.id)if(e.id){var n={};n[e.id]=e,t(n)}else t(e)}),G.on("newBullet",function(e){an[e.id]||e.owner===Q.id||(an[e.id]=e,B(e.x))}),G.on("killBullet",function(e){an[e]&&delete an[e]}),G.on("killedMonster",function(e){un[e]&&delete un[e]}),G.on("userDamaged",function(e){var n=rn[e.id];n&&!n.isDead&&(n.health=e.health,n.hitCountdown=100)}),G.on("shotgunPowerUpDrop",function(e){on[e.id]=e,hn=1}),G.on("healthPowerUpDrop",function(e){on[e.id]=e,pn=1}),G.on("userDeath",function(e,n){var t=rn[e];t&&!t.isDead&&(t.isDead=1,e===X&&(nn.innerHTML=n,o(),p()))}),G.on("userNotInvincible",function(e){var n=rn[e];n&&(n.isInvincible=0)}),G.on("wave",function(e){console.log("WAVE "+e)}),G.on("userPickup",function(e,n){var t=rn[e];if(!t.isDead&&(delete on[n.id],hn=0,pn=0,"health"===n.type&&(t.health=10),t.id===Q.id&&(t.powerup=n,tn="shotgun"===t.powerup.type?500:150,r(),t.powerup&&"shotgun"===t.powerup.type))){var i=1e4;tn="shotgun"===t.powerup.type?500:150,clearTimeout(_),_=setTimeout(function(){t.powerup="",G.emit("powerUpEnd",{id:t.id}),tn="shotgun"===t.powerup.type?500:150,r(),i-=1e3},i)}}),G.on("updateScore",function(e){sn=e,S()}),window.addEventListener("keydown",function(e){Q.name&&!Q.isDead&&e.preventDefault(),ln[e.keyCode]=!0}),window.addEventListener("keyup",function(e){Q.name&&!Q.isDead&&e.preventDefault(),delete ln[e.keyCode]}),en.addEventListener("click",i);var wn=1;r();var gn=!0;setInterval(function(){gn=!0},500);var mn,xn=Math.PI/180,kn={x:0,y:0},Cn=1,Dn={x:0,y:0},bn=Image,Mn=new bn;Mn.onload=function(){mn=Y.createPattern(Mn,"repeat")},Mn.src="images/grass3.jpg";var In=new bn;In.src="images/monster-right.png";var Tn=new bn;Tn.src="images/character-sprite-reg.png";var Sn=new webkitAudioContext,Pn=R(),Rn=Sn.createBiquadFilter();Rn.type=0,Rn.frequency.value=900,Rn.connect(Sn.destination);var Bn,En=[[30,,,,30,,,,30,,,,30,,,,30,,,,30,,25,,30,,25,,30,,32],[,,,,54,,,,,,52,,54,,56,,57,,,,,,,,,,49],[,,,,,,,,,,,,,,,,,,,,,69,66,69,,69]],Nn=!1,Ln=132,qn=25,An=.1,Un=0,Fn=.04,Gn=0,Hn=-1,Jn=[];musicContext=new webkitAudioContext,musicGainNode=musicContext.createGain(),musicGainNode.connect(musicContext.destination),musicGainNode.gain.value=.15,F(),U()}();