!function(){function e(e){return R.getElementById(e)}function n(e){return R.createElement(e)}function t(e){var n,t,i;for(var r in e)n=e[r],t=n.id,isMonster="monster"===n.type,i=isMonster?G[t]:U[t],i&&j&&t!==j.id&&(i.x=n.x,i.y=n.y),isMonster?G[t]=n:i&&(i.facing=n.facing)}function i(){if(!J){var e=U[j.id];e.isDead=0,S.emit("userRespawn",{id:j.id}),V=0,J=10,A.style.display="none",E.className=""}}function r(){if(!V){V=1,J=10;var n=e("timer");n.innerHTML=J;var t=setInterval(function(){n.innerHTML=--J,0===J&&(n.innerHTML="Respawn",clearTimeout(t))},1e3)}}function a(){if(_&&!j.isInvincible){_=!1;var e=v(j);e&&(j.health-=e.damage,j.health<=0&&(j.isDead=1)&&(E.className="d",A.style.display="block"),S.emit("hitUser",{id:j.id,damage:e.damage,fromMonster:1}))}}function o(e,n,t){return e.y=e.y+Math.sin(nn*n)*t,e.x=e.x+Math.cos(nn*n)*t,e}function l(){if(j.isDead)return!J&&32 in K&&i(),void 0;if(d()){var e=0!==Object.keys(K).length&&j.speed*q,n=!1;65 in K?n=83 in K?135:87 in K?225:180:68 in K?n=83 in K?45:87 in K?315:0:87 in K?n=270:83 in K&&(n=90),n!==!1&&(tn.x=j.x,tn.y=j.y,tn=o(tn,n,e),j.x=tn.x,j.y=tn.y,S.emit("updateMovement",j))}var t;38 in K?t=37 in K?"up-left":39 in K?"up-right":"up":40 in K?t=37 in K?"down-left":39 in K?"down-right":"down":37 in K?t="left":39 in K&&(t="right"),t&&(j.facing=t)&&S.emit("updateMovement",j);var n=0,r=0,a=0;if(32 in K){if($){"up"===j.facing?(n=270,r=-10,a=-30):"up-left"===j.facing?(n=225,r=-25,a=-15):"up-right"===j.facing?(n=315,r=10,a=-20):"down"===j.facing?(n=90,r=-10,a=0):"down-left"===j.facing?(n=135,r=-15,a=5):"down-right"===j.facing?(n=45,r=5,a=5):"left"===j.facing?(n=180,r=-25):"right"===j.facing&&(n=0);var l=new s(j.x+j.height/2+r,j.y+j.width/2+a,j.facing,n,j.id);Y[l.id]=l,S.emit("newBullet",l),C(l.x)}$=!1}}function c(){for(var e=B();z[e];)e=B();return z[e]=1,e}function d(){return j.x<=0||j.y<=0?(j.x=j.x+1,j.y=j.y+1,!1):j.x>=760?(j.x=j.x-5,!1):j.y>=550?(j.y=j.y-5,!1):!0}function s(e,n,t,i,r){var a=this;a.owner=r,a.id=r+c(),a.x=e,a.y=n,a.width=5,a.height=5,a.direction=t,a.angle=i,a.speed=500}function f(){var e;for(var n in Y)e=Y[n],e.owner===j.id&&delete Y[n]}function u(e){e.direction;var n=e.speed*q;if(rn.x=e.x,rn.y=e.y,rn=o(rn,e.angle,n),e.x=rn.x,e.y=rn.y,e.owner===F){var t=e.owner,i=g(e);if(!i)return delete Y[e.id],S.emit("killBullet",e.id),void 0;var r=y(e);!r||r.isInvincible||r.isDead||(r.health-=1,r.health<=0&&delete U[r.id],S.emit("hitUser",{id:r.id,damage:1,shooter:t}));var a=v(e);a&&(a.health-=1,a.health<=0&&delete G[a.id],S.emit("hitMonster",{id:a.id,damage:1,shooter:t})),(r||a)&&(delete Y[e.id],S.emit("killBullet",e.id))}}function h(e,n){var t=e.width+e.x,i=n.width+n.x;if(n.x>t||e.x>i)return!1;var r=e.height+e.y,a=n.height+n.y;return n.y>r||e.y>a?!1:!0}function y(e){var n,t;for(var i in U)if(n=U[i],n.id!==F&&(t=h(e,n)))return n;return!1}function v(e){var n,t;for(var i in G)if(n=G[i],t=h(e,n))return n;return!1}function g(e){return e.x>800||e.y>600||e.x<0||e.y<0?!1:!0}function w(e){var n=[];for(var t in U)n.push(U[t]);for(var i in G)n.push(G[i]);n.sort(function(e,n){return e.x===n.x&&e.y===n.y&&e.type!==n.type?"monster"===e.type?1:-1:e.y===n.y?e.x>n.x?1:e.x<n.x?-1:0:e.y>n.y?1:-1});for(var r,a=0,o=n.length;o>a;a++)r=n[a],"player"===r.type&&!r.isDead&&r.isConnected?m(e,r):"monster"===r.type&&p(e,r)}function m(e,n){var t;if(n.hitCountdown&&1===n.hitCountdown%10&&(n.show=!n.show),n.hitCountdown--,n.hitCountdown||(n.show=1),n.show){k(e,n),e.beginPath(),e.fillStyle="white",t=cn;var i=j.id===n.id?"You":n.name;e.fillText(i,n.x+12,n.y+65);var r=0;switch(n.facing){case"up":break;case"up-left":r=52;break;case"down":r=358;break;case"down-left":r=307;break;case"left":r=205;break;case"right":r=154;break;case"up-right":r=102;break;case"down-right":r=256}e.drawImage(t,0,r,49,49,n.x,n.y,40,45),e.fill(),e.stroke(),e.closePath()}}function p(e,n){e.drawImage(ln,n.x,n.y,n.width,n.height)}function x(){en&&(N.rect(0,0,E.width,E.height),N.fillStyle=en,N.fill()),N.fillRect(0,0,E.width,E.height),w(N);var e,n;for(var t in Y)e=Y[t],n=e&&U[e.owner],e&&n&&!n.isDead&&(u(e),e&&(N.fillStyle="#d62822"),e&&N.fillRect(e.x,e.y,3,3),e&&(N.fillStyle="#f2b830"),e&&N.fillRect(e.x+4,e.y,3,3));var i=U[F].health;N.fillStyle="rgba(255, 0, 0, 0.5)";var r=(E.width-10)/10,a=r*i;N.fillRect(5,5,a,15)}function k(e,n){var t="left"===n.facing||"down-left"===n.facing||"up-left"===n.facing?15:"down"===n.facing||"up"===n.facing?10.5:5;e.fillStyle=n.color,e.fillRect(n.x+t,n.y+25,20,10),e.fillStyle=n.eyeColor,e.fillRect(n.x+t+3,n.y+10,14,10),e.fillStyle=n.pantsColor,e.fillRect(n.x-1+t+2,n.y+35,17,7)}function b(){var e,t,i,r=R.createDocumentFragment();Q.sort(function(e,n){return e.score>n.score?-1:e.score<n.score?1:0});for(var a in Q)i=Q[a],e=n("tr"),e.style.outline="thin solid "+i.color,t=n("td"),t.innerText=i.name,e.appendChild(t),t=n("td"),t.innerText=i.score,e.appendChild(t),r.appendChild(e);P.innerHTML="",P.appendChild(r)}function M(){q=(Date.now()-W)/1e3,a(),l(),x(),W=Date.now(),window.requestAnimationFrame(M)}function D(){for(var e=2*dn.sampleRate,n=dn.createBuffer(1,e,dn.sampleRate),t=n.getChannelData(0),i=0;e>i;i++)t[i]=2*B()-1;return n}function C(e){var n=dn.createBufferSource(),t=dn.createPanner();I(e,t),n.connect(t),fn.frequency.value=900+L(201*B())-100,t.connect(fn),n.buffer=sn,n.loop=!0,n.loopStart=B()*(sn.duration/2),n.start(0),n.stop(dn.currentTime+.04)}function I(e,n){E.width;var t,i=L(E.width/2),r=22;e===i?t=0:i>e?t=(i-e)/i*-r:e>i&&(t=(e-i)/i*r);var a=t,o=a+90;o>90&&(o=180-o);var l=Math.sin(a*(Math.PI/180)),c=Math.sin(o*(Math.PI/180));n.setPosition(l,0,c)}var S=io.connect("http://shootah.nodejitsu.com:80"),R=document,T=Math,B=T.random,L=T.floor,E=e("canvas"),P=e("st"),N=E.getContext("2d");E.width=800,E.height=600;var q,H,j,F,J,A=e("r"),O=e("m"),U={},Y={},z={},G={},K={},Q={},V=0,W=Date.now();try{var X=window.localStorage.getItem("user");j=X?JSON.parse(X):{},j.isDead=0,j.health=10,j.name?S.emit("userJoined",j):(E.style.display="none",e("c").style.display="block",e("submit").addEventListener("click",function(){var n=R.getElementsByTagName("input")[0].value;n&&(j.name=n,E.style.display="block",e("c").style.display="none",S.emit("userJoined",j))}))}catch(Z){throw new Error(Z)}S.on("join",function(e){H=S.socket.sessionid,e.socketId===H&&(console.log(e),window.localStorage.setItem("user",JSON.stringify(e)),j=e,F=e.id,window.requestAnimationFrame(M)),U[e.id]=e}),S.on("move",function(e){if(e.id){var n={};n[e.id]=e,t(n)}else t(e)}),S.on("newBullet",function(e){Y[e.id]||(Y[e.id]=e,C(e.x))}),S.on("killBullet",function(e){Y[e]&&delete Y[e]}),S.on("killedMonster",function(e){G[e]&&delete G[e]}),S.on("userDamaged",function(e){var n=U[e.id];n&&(n.health=e.health,n.hitCountdown=100)}),S.on("userDeath",function(e,n){var t=U[e];t&&(t.isDead=1,e===F&&(O.innerHTML=n,r(),f()))}),S.on("userNotInvincible",function(e){var n=U[e];n&&(n.isInvincible=0)}),S.on("updateScore",function(e){Q=e,b()}),window.addEventListener("keydown",function(e){j.name&&!j.isDead&&e.preventDefault(),K[e.keyCode]=!0}),window.addEventListener("keyup",function(e){j.name&&!j.isDead&&e.preventDefault(),delete K[e.keyCode]}),A.addEventListener("click",i);var $=!0;setInterval(function(){$=!0},150);var _=!0;setInterval(function(){_=!0},500);var en,nn=Math.PI/180,tn={x:0,y:0},rn={x:0,y:0},an=Image,on=new an;on.onload=function(){en=N.createPattern(on,"repeat")},on.src="images/grass3.jpg";var ln=new an;ln.src="images/monster-right.png";var cn=new an;cn.src="images/character-sprite-reg.png";var dn=new webkitAudioContext,sn=D(),fn=dn.createBiquadFilter();fn.type=0,fn.frequency.value=900,fn.connect(dn.destination)}();